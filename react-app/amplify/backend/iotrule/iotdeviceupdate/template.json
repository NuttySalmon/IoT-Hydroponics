{
  "Parameters": {
    "env": {
      "Type": "String"
    },
    "functionhandleIoTDataArn": {
      "Type": "String"
    },
    "IoTRuleName": {
      "Type": "String"
    },
    "IoTRuleSQL": {
      "Type": "String"
    }
  },
  "Resources": {
    "IotDeviceUpdateRule": {
      "Type": "AWS::IoT::TopicRule",
      "Properties": {
        "RuleName": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "IoTRuleName"
              },
              "_",
              {
                "Ref": "env"
              }
            ]
          ]
        },
        "TopicRulePayload": {
          "AwsIotSqlVersion": "2016-03-23",
          "Actions": [
            {
              "Lambda": {
                "FunctionArn": { "Ref": "functionhandleIoTDataArn" }
              }
            }
          ],
          "RuleDisabled": false,
          "Sql": {
            "Ref": "IoTRuleSQL"
          }
        }
      }
    },
    "handleIoTDataAllowIOTRuleInvocation": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "Action": "lambda:InvokeFunction",
        "FunctionName": {
          "Fn::Select": [
            "6",
            {
              "Fn::Split": [":", { "Ref": "functionhandleIoTDataArn" }]
            }
          ]
        },
        "Principal": "iot.amazonaws.com",
        "SourceArn": {
          "Fn::GetAtt": ["IotDeviceUpdateRule", "Arn"]
        }
      }
    }
  }
}
